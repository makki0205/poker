# Test Plan (MVP)

## 1. 目的
- ポーカー進行ロジックの正しさを継続的に担保する
- API/リアルタイム同期の回帰を早期検知する
- 今後の機能追加でもテストを壊れにくくする

## 2. テスト方針
- 単体テスト中心でルールロジックを固定
- APIとWSは統合テストで契約を保証
- モバイルUIはE2Eで主要動線のみ保証
- 失敗時に原因特定しやすい粒度で分割

## 3. 対象レイヤー

### 3.1 Unit (高速)
対象:
- ハンド評価
- ベッティングラウンド状態遷移
- ポット/サイドポット計算
- ブラインドレベル進行
- Bot行動選択（簡易戦略）

観点:
- 正常系: 期待どおりの状態遷移
- 異常系: 不正アクション拒否
- 境界値: all-in, 最小レイズ, 同額引き分け, 複数サイドポット

### 3.2 Integration (中速)
対象:
- Hono HTTPハンドラ
- WebSocketイベント配信
- In-memory storeとの連携

観点:
- 参加〜開始〜終了までのAPI連携
- WSでの `table.snapshot` / `action.applied` / `hand.finished`
- 再接続時の状態復元

### 3.3 E2E (低速)
対象:
- モバイルUIの実ユーザーフロー

観点:
- ロビーで作成・参加・観戦
- プレイヤー行動が画面に反映
- 観戦者は操作不可
- 結果画面表示

## 4. 推奨ツール
- Unit/Integration: `vitest`
- APIテスト: `supertest` または `undici` ベース
- WebSocketテスト: `ws` クライアント
- E2E: `playwright`（モバイルviewport）
- カバレッジ: `c8` or vitest coverage

## 5. テストケース計画

### 5.1 ゲームルール
- プリフロップでBB以外全員フォールド -> BB勝利
- 複数all-inでサイドポットが正しく分配される
- ショーダウンで同役の分配が等分になる
- アンティ徴収後にスタックが0以下にならない

### 5.2 トーナメント
- 30/60/90分選択ごとにブラインド進行が切り替わる
- 脱落プレイヤーがリバイで復帰できる
- リバイ回数が増えても状態が破綻しない
- 最後の1人になったら `finished` になる

### 5.3 Bot
- 指定人数分のBotが開始時に配置される
- Botが手番外で行動しない
- Botアクションが許可範囲外値を出さない

### 5.4 リアルタイム
- 手番のたびに全クライアントへ差分配信される
- 再接続時にスナップショットが取得できる
- 観戦者に手札秘匿ルールが適用される

## 6. CI実行計画
1. `lint` / `typecheck`
2. Unit tests
3. Integration tests
4. E2E (headless, mobile profile)
5. カバレッジ閾値チェック

## 7. 品質ゲート（MVP）
- Unit: statement coverage 80%以上
- 重大ロジック（ハンド評価/ポット分配/状態遷移）: branch coverage 90%以上
- Integration: 主要APIと主要WSイベントをすべて網羅
- E2E: 最低3シナリオ（参加, プレイ, 観戦）を常時green

## 8. 運用ルール
- バグ修正時は再発防止テストを必須追加
- 新規機能は「API契約テスト + 主要ユニットテスト」を同時追加
- flakyなE2Eは放置せず、同日中に安定化または隔離する
